---
import { getCollection, render } from 'astro:content'
import BaseLayout from '../../layouts/BaseLayout.astro';
import Bio from '../../components/Bio.astro';

export async function getStaticPaths() {
	const posts = await getCollection('posts')
  return posts.map(p => ({
    params: { slug: p.data.slug },
    props: { post: p },
  }));
}

const { post } = Astro.props
const { title, slug, description, publishDate, tags = [] } = post.data;

// Простая функция для расчета времени чтения
function calculateReadingTime(text) {
  const wordsPerMinute = 200;
  const words = text.split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
}

const readingTimeEstimate = calculateReadingTime(post.body);
const permalink = `${Astro.site.href}blog/${slug}`;
const { Content } = await render(post)

// Форматирование даты
const dateObj = new Date(publishDate);
const isoDate = dateObj.toISOString();
const formattedDate = dateObj.toLocaleDateString('ru-RU', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<BaseLayout title={title} description={description} permalink={permalink} current="blog">
  <article style="padding: 2.5rem 1rem; margin: 0 auto;">
    <div style="max-width: 900px; margin: 0 auto;">
      
      {/* Header */}
      <header style="text-align: center; margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
          <time datetime={isoDate}>{formattedDate}</time>
          <span>·</span>
          <span>{readingTimeEstimate} мин чтения</span>
        </div>
        <h1 style="font-weight: 800; font-size: 2.25rem; margin-bottom: 1rem; line-height: 1.2;">
          {title}
        </h1>
        <p style="font-size: 1.125rem; color: var(--text-secondary); max-width: 700px; margin: 0 auto; line-height: 1.6;">
          {description}
        </p>
      </header>

      {/* Content */}
      <div style="margin-bottom: 3rem; line-height: 1.8; color: var(--text-main);">
        <Content />
      </div>

      {/* Tags */}
      {tags && tags.length > 0 && (
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border-color);">
          {tags.map((tag) => (
            <a 
              href={`/blog/tags/${tag}`}
              style="display: inline-block; padding: 0.35rem 0.75rem; background-color: #dbeafe; color: #1e40af; border-radius: 0.375rem; font-size: 0.875rem; text-decoration: none; transition: background-color 0.2s;"
            >
              #{tag}
            </a>
          ))}
        </div>
      )}

      {/* Bio */}
      <Bio />
    </div>
  </article>
</BaseLayout>

<style>
  article {
    color: var(--text-main) !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  article * {
    opacity: 1 !important;
    visibility: visible !important;
  }

  article h1 {
    font-size: 2.25rem;
    font-weight: 800;
    margin-bottom: 1rem;
    line-height: 1.2;
  }

  article h2 {
    font-size: 1.75rem;
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
  }

  article h3 {
    font-size: 1.375rem;
    font-weight: 700;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  article h4 {
    font-size: 1.125rem;
    font-weight: 700;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }

  article h5,
  article h6 {
    font-size: 1rem;
    font-weight: 700;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }

  article p {
    margin-bottom: 1rem;
    line-height: 1.8;
    color: var(--text-main);
  }

  article ul,
  article ol {
    margin-bottom: 1rem;
    margin-left: 2rem;
  }

  article li {
    margin-bottom: 0.5rem;
    line-height: 1.8;
    color: var(--text-main);
  }

  article blockquote {
    border-left: 4px solid var(--primary-color);
    background-color: var(--bg-offset);
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 0.375rem;
    font-style: italic;
    color: var(--text-main);
  }

  article a {
    color: var(--primary-color);
    text-decoration: none;
    border-bottom: 1px solid var(--primary-color);
    transition: color 0.2s;
  }

  article a:hover {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
  }

  article code {
    background-color: var(--bg-offset);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: #d64545;
  }

  article pre {
    background-color: var(--bg-offset);
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-bottom: 1rem;
    border: 1px solid var(--border-color);
  }

  article pre code {
    background-color: transparent;
    padding: 0;
    color: var(--text-main);
  }

  article img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 1.5rem 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  article table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }

  article th {
    background-color: var(--bg-offset);
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    border: 1px solid var(--border-color);
  }

  article td {
    padding: 0.75rem;
    border: 1px solid var(--border-color);
  }

  article hr {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 2rem 0;
  }

  article strong {
    font-weight: 700;
  }

  article em {
    font-style: italic;
  }
</style>
